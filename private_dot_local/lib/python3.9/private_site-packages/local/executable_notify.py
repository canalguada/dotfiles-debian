#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# vim: set ai ts=4 sw=4 tw=79:

import os
import click
import notify2
import psutil

PROGNAME = 'notify'
VERSION = '0.1'

p = psutil.Process(os.getpid())
default_title = p.parent().name()
default_id = f'{p.username()}.{default_title}'


@click.command(help='A program to send desktop notifications')
@click.version_option(version=VERSION, prog_name=PROGNAME)
@click.option('--icon', '-i', help='Use this icon',
              default='info')
@click.option('--title', '-t', help='Use this title',
              default=default_title)
@click.option('--id', help='Use this id',
              default=default_id)
@click.option('--timeout', help='Use this timeout',
              default=5000)
@click.argument('input', type=click.File('rb'), metavar='FILE')
def notify(icon, title, id, timeout, input):
    # stdin = click.get_text_stream('stdin')
    body = '\n'.join([line.decode('utf-8').strip('\n')
                      for line in input.readlines()])

    notify2.init(id, None)
    n = notify2.Notification(title, message=body, icon=icon)
    try:
        timeout = int(timeout)
        if type(timeout) == int and timeout > 0:
            n.timeout = timeout
        else:
            n.timeout = notify2.EXPIRES_DEFAULT
    except:
        n.timeout = notify2.EXPIRES_NEVER
    n.show()


if __name__ == "__main__":
    notify()
